# Hybrid Disaster Recovery (DR) Plan

This document describes the architecture and procedure for maintaining an active (hot standby) replica of the PostgreSQL database from the EKS cluster in AWS to a local, on-premise server.

## Solution Architecture

The solution is based on continuous physical replication of PostgreSQL, ensuring a near-zero Recovery Point Objective (RPO ~ 0) and a low Recovery Time Objective (RTO).

1.  **Secure Connection:** An **AWS Site-to-Site VPN** tunnel is established between the AWS VPC and the company's on-premise network. All replication traffic travels through this encrypted tunnel.

2.  **Continuous Backup to S3:** The primary database in EKS (managed by the Zalando Operator) continuously archives its transaction logs (WALs) to a dedicated S3 bucket.

3.  **Dual Replication:** The on-premise replica uses a two-phase system to stay in sync:
    * **Streaming Replication:** It receives data in real-time directly from the AWS primary via the VPN. This is the primary and fastest method.
    * **WAL Recovery:** If the streaming connection is interrupted, the replica automatically recovers any missing WAL segments from the archive in the S3 bucket. This guarantees that no transactions are lost.

## Initial Setup Process

1.  **Provision Network Infrastructure:**
    * Fill in the example values (public IP and CIDR of the on-premise network) in `/infra/vpn-onpremise/environments/pro/terragrunt.hcl`.
    * Run `terragrunt apply` from that directory to create the VPN connection. Your on-premise network team will need to configure their side of the tunnel using the configuration generated by Terraform.

2.  **Prepare On-Premise Server:**
    * Ensure you have a server with PostgreSQL installed and the AWS CLI configured with credentials that have read access to the WALs S3 bucket.

3.  **Execute Restoration:**
    * Take a base backup of the production database in AWS and upload it to the S3 bucket (e.g., `s3://<your-bucket>/base.tar.gz`).
    * Copy and execute the `/disaster-recovery/restore_and_replicate_onprem.sh` script on the on-premise server. This script automates downloading the backup, restoring it, and configuring the replication.

## Failover Procedure (Switchover)

This is the controlled, manual process to convert the on-premise replica into the new primary database.

1.  **Place Application in Maintenance Mode:** Stop write traffic to the application to prevent data loss during the transition.
2.  **Verify Replication Lag:** Ensure the on-premise replica has received and applied all transactions from the primary.
3.  **Promote the Replica:** Connect to the on-premise server and execute the script:
    ```bash
    ./disaster-recovery/promote_onprem_to_primary.sh
    ```
4.  **Update Application Configuration:**
    * Edit the Kubernetes `Secret` that holds the database connection string.
    * Change the `HOST` to point to the IP address of the on-premise server (accessible via the VPN).
5.  **Redeploy the Application:** Run `kubectl rollout restart deployment/hello-birthday-app` so that the application pods load the new configuration and connect to the on-premise database.
6.  **Decommission the Old Primary:** Shut down the database in AWS to prevent a "split-brain" scenario.
7.  **Disable Maintenance Mode:** The application is now fully operational, running from the on-premise environment.